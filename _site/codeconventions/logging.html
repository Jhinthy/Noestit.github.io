<h2 id="introduction">Introduction</h2>

<p>Logging is a critical part in any application. When the end-user faces an error or unexpected behavior in the application, you want to have a trace or at least some pointer at what went wrong. Logging exceptions with a stacktrace is very helpful in that regard, while for some complex operations, you might decide to log additional side information to better understand the program flow. To distinguish trace data from error data, any decent logging framework also logs a level with each message and allows you to decide which level of messages you actually want to store.</p>

<p>A lot of logging frameworks exist but two of them are quite popular in the .NET world:</p>

<ul>
  <li>log4net <a href="https://www.nuget.org/packages/log4net/">NuGet</a></li>
  <li>Serilog <a href="https://www.nuget.org/packages/serilog/">NuGet</a></li>
  <li>Microsoft.Extensions.Logging <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0">Microsoft docs</a></li>
</ul>

<p>Compared to log4net, Serilog has additional support for structured logging so could be the better choice for more complex applications.</p>

<p>Both of these frameworks have a lot of different output methods: they can write to a file, write to a console, write to Windows Event log, write as XML, write as plain-text, write to a database, write to telnet, and so on. Log4Net calls them <code class="language-plaintext highlighter-rouge">Appenders</code> while Serilog calls them <code class="language-plaintext highlighter-rouge">Sinks</code>. See <a href="https://logging.apache.org/log4net/release/features.html">log4net features</a> or <a href="https://github.com/serilog/serilog/wiki/Provided-Sinks">Serilog sinks</a>.</p>

<h2 id="logging-and-unit-testing">Logging and unit-testing</h2>

<p>In both frameworks, you can choose to create different loggers for different context (f.e. different classes) or create one logger for the entire application. In any case, when running unit-tests, you don’t want to log anything to disk or any other output, so it’s advisable to inject a logging interface instead of directly calling a static <code class="language-plaintext highlighter-rouge">Log</code> class from the code.</p>

<p>When a context logger per class is used, you can use this method:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// With log4net:</span>
<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILog</span> <span class="n">_logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">UserService</span><span class="p">(</span><span class="cm">/* other required dependencies */</span><span class="p">,</span> <span class="n">ILog</span> <span class="n">logger</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span> <span class="p">??</span> <span class="n">LogManager</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">UserService</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SomeMethod</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">"Some warning"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// With Serilog:</span>
<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">UserService</span><span class="p">(</span><span class="cm">/* other required dependencies */</span><span class="p">,</span> <span class="n">ILogger</span> <span class="n">logger</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span> <span class="p">??</span> <span class="n">Log</span><span class="p">.</span><span class="n">ForContext</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SomeMethod</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">"Some warning"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// With Microsoft.Extensions.Logger</span>
<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">UserService</span><span class="p">(</span><span class="cm">/* other required dependencies */</span><span class="p">,</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;</span> <span class="n">logger</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span> <span class="p">??</span> <span class="n">Log</span><span class="p">.</span><span class="n">ForContext</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SomeMethod</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">"Some warning"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This way, at runtime, dependency injection will not inject a logger and a context specific logger will be created in the constructor. While in unit-tests you can pass a mock logger and even verify certain logging behavior.</p>

<h3 id="structured-logging">Structured logging</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logger.Info("Logon by {0} from {1}", "Kenny", "127.0.0.1"); // Logon by "Kenny" from "127.0.0.1"`

logger.Info("Logon by {user} from {ip_address}", "Kenny", "127.0.0.1"); // Logon by "Kenny" from "127.0.0.1"`
</code></pre></div></div>

<p>Using @ will format the object as json</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var order = new Order
{
    OrderId = 2,
    Status = OrderStatus.Processing
};


logger.Info("Test {value1}", order); // object Result:  Test MyProgram.Program+Order
logger.Info("Test {@value1}", order); // object Result:  Test {"OrderId":2, "Status":"Processing"}
</code></pre></div></div>

<h3 id="serilog">SeriLog</h3>

<p>SeriLog is easy to set up, has a clean <code class="language-plaintext highlighter-rouge">API</code> and can be used in all recent .NET platforms.</p>

<p><strong>Configure SeriLog &amp; Sinks</strong></p>

<p>Create the logger using a <code class="language-plaintext highlighter-rouge">LoggerConfiguration</code> object.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Log</span><span class="p">.</span><span class="n">Logger</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">().</span><span class="nf">CreateLogger</span><span class="p">();</span>
<span class="n">Log</span><span class="p">.</span><span class="nf">Information</span><span class="p">(</span><span class="s">"Who will read this?"</span><span class="p">);</span>
</code></pre></div></div>

<p>The above code example creates a logger that doesn’t log any event anywhere. To log events, a sink must be configured.
Sinks are configures using the <code class="language-plaintext highlighter-rouge">WriteTo</code> configuration object.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Log</span><span class="p">.</span><span class="n">Logger</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">()</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">CreateLogger</span><span class="p">();</span>

<span class="c1">//Log event</span>
<span class="n">Log</span><span class="p">.</span><span class="nf">Information</span><span class="p">(</span><span class="s">"Now you can read this in the console!"</span><span class="p">);</span>
</code></pre></div></div>

<p>The example above will write information logs to the console.
You can configure multiple sinks, by chaining the <code class="language-plaintext highlighter-rouge">WriteTo</code> blocks. In the example below, a minimum log event level is passed to the configuration.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Log</span><span class="p">.</span><span class="n">Logger</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">()</span>
    <span class="p">.</span><span class="n">MinimulLevel</span><span class="p">.</span><span class="nf">Debug</span><span class="p">()</span> <span class="c1">//Override for logger</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">(</span><span class="n">restrictedToMinimumLevel</span><span class="p">:</span> <span class="n">LogEventLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">)</span> <span class="c1">//Override per sink</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">File</span><span class="p">(</span><span class="s">"log.txt"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">CreateLogger</span><span class="p">();</span>
</code></pre></div></div>

<p><strong>Creating a custom sink</strong>*</p>

<p>A sink is nothing more than a <code class="language-plaintext highlighter-rouge">class</code> that implements <code class="language-plaintext highlighter-rouge">ILogEventSink</code>. The example below creates a <code class="language-plaintext highlighter-rouge">sink</code> that renders every message to the console, regardless of the log level.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MyCustomSink</span><span class="p">:</span> <span class="n">ILogEventSink</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IFormatProvider</span> <span class="n">_formatProvider</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MyCustomSink</span><span class="p">(</span><span class="n">IFormatProvider</span> <span class="n">formatProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_formatProvider</span> <span class="p">=</span> <span class="n">formatProvider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Emit</span><span class="p">(</span><span class="n">LogEvent</span> <span class="n">logEvent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="nf">RenderMessage</span><span class="p">(</span><span class="n">_formatProvider</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">DateTimeOffSet</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s"> </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Extensions for configuration</strong></p>

<p>When configuring a sink, a extension method can be provided.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MyCustomSinkExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">LoggerConfiguration</span> <span class="nf">MyCustomSink</span><span class="p">(</span>
              <span class="k">this</span> <span class="n">LoggerSinkConfiguration</span> <span class="n">loggerConfiguration</span><span class="p">,</span>
              <span class="n">IFormatProvider</span> <span class="n">formatProvider</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">loggerConfiguration</span><span class="p">.</span><span class="nf">Sink</span><span class="p">(</span><span class="k">new</span> <span class="nf">MyCustomSink</span><span class="p">(</span><span class="n">formatProvider</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can now use sink in your <code class="language-plaintext highlighter-rouge">LoggerConfiguration</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">log</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">()</span>
    <span class="p">.</span><span class="n">MinimumLevel</span><span class="p">.</span><span class="nf">Information</span><span class="p">()</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">MyCustomSink</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">CreateLogger</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="additional-resources">Additional resources</h2>

<ul>
  <li><a href="https://stackify.com/log4net-guide-dotnet-logging/">Ultimate log4net Tutorial for .NET Logging</a></li>
  <li><a href="https://blog.getseq.net/serilog-tutorial/">Serilog tutorial</a></li>
</ul>
